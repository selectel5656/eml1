{% extends 'base.html' %}
{% block title %}Письмо{% endblock %}
{% block content %}
<h2>Письмо</h2>
<form method="post">
  <div class="mb-3">
    <label class="form-label">Тема</label>
    <input class="form-control" name="subject">
  </div>
  <div class="mb-3">
    <label class="form-label">Текст</label>
    <textarea class="form-control" name="body" rows="6"></textarea>
  </div>
  <div class="mb-3">
    <label class="form-label">Аттачи</label><br>
    {% for a in attachments %}
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="attachments" value="{{ a.id }}" id="att{{a.id}}">
        <label class="form-check-label" for="att{{a.id}}">{{ a.display_name }} ({{ a.send_filename or a.filename }})
          {% if a.macro_base64 %} макрос: {{'{{$'+a.macro_base64+'}}'}}{% endif %}
          {% if a.macro_url %} url: {{'{{$'+a.macro_url+'}}'}}{% endif %}
          {% if a.macro_id %} id: {{'{{$'+a.macro_id+'}}'}}{% endif %}
          {% if a.inline and a.macro_base64 %}
            {% set ext = a.filename.split('.')[-1].lower() %}
            <br><small>пример: &lt;img src="data:image/{{ext}};base64,{{'{{$'+a.macro_base64+'}}'}}"></small>
          {% endif %}
        </label>
      </div><br>
    {% endfor %}
  </div>
  <button class="btn btn-primary" name="action" value="start">Старт</button>
  <button class="btn btn-danger" name="action" value="stop">Стоп</button>
  <a class="btn btn-secondary" href="{{ url_for('reset_counts') }}">Скинуть счетчики отправок</a>
</form>

<div class="mt-3">
  <div class="progress">
    <div id="progbar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
  </div>
  <div class="mt-2">
    <span id="progtext">0/0</span>
    <span class="ms-3">Ошибок аккаунтов: <span id="errcount">0</span></span>
    <a id="errlink" href="{{ url_for('error_log') }}" class="btn btn-sm btn-outline-secondary ms-2" style="display:none">Скачать ошибки</a>
  </div>
</div>

<script>
function updateProgress(){
  fetch("{{ url_for('progress') }}").then(r=>r.json()).then(data=>{
    document.getElementById('progbar').style.width=data.percent+"%";
    document.getElementById('progbar').textContent=data.percent+"%";
    document.getElementById('progtext').textContent=data.sent+"/"+data.total;
    document.getElementById('errcount').textContent=data.errors;
    document.getElementById('errlink').style.display=data.errors>0?'inline-block':'none';
  });
}
setInterval(updateProgress,1000);
updateProgress();
</script>
{% endblock %}
