{% extends 'base.html' %}
{% block title %}Макросы{% endblock %}
{% block content %}
<h2>Макросы</h2>
<table class="table">
<tr><th>Имя</th><th>Тип</th><th>Текущее значение</th><th>Действия</th></tr>
{% for m in macros %}
<tr>
  <td>{{'{{$'+m.name+'}}'}}</td>
  <td>{{m.macro_type}}</td>
  <td>{{m.current_value}}</td>
  <td><a class="btn btn-sm btn-danger" href="{{ url_for('delete_macro', macro_id=m.id) }}" onclick="return confirm('Удалить?');">Удалить</a></td>
</tr>
{% endfor %}
</table>
<h3>Добавить макрос</h3>
<form method="post" enctype="multipart/form-data">
<div class="mb-3">
  <label class="form-label">Имя</label>
  <input class="form-control" name="name">
</div>
 <div class="mb-3">
   <label class="form-label">Тип</label>
   <select name="macro_type" class="form-select" id="macro_type">
     <option value="counter">Счётчик</option>
    <option value="random">Рандом</option>
    <option value="list">Список</option>
    <option value="multi">Мультимакрос</option>
   </select>
 </div>
 <div id="counter_fields">
   <label>Начальное значение</label><input name="start" class="form-control">
   <label>Шаг</label><input name="step" class="form-control">
 </div>
<div id="random_fields" style="display:none;">
   <label>Символы</label><input name="chars" class="form-control" value="abcdefghijklmnopqrstuvwxyz">
   <label>Длина от</label><input name="min_len" class="form-control" value="5">
   <label>Длина до</label><input name="max_len" class="form-control" value="10">
</div>
<div id="list_fields" style="display:none;">
  <label>Файл списка</label><input type="file" name="file" class="form-control">
  <label>Что брать</label>
  <select name="source" class="form-select">
    <option value="lines">Строки</option>
    <option value="words">Слова</option>
    <option value="sentences">Предложения</option>
  </select>
 <label>Как брать</label>
 <select name="mode" class="form-select">
    <option value="random">Рандомно</option>
    <option value="sequential">Последовательно</option>
 </select>
  <label class="mt-2">Слов в предложении (от - до)</label>
  <div class="input-group mb-2">
    <input name="words_min" class="form-control">
    <input name="words_max" class="form-control">
  </div>
  <label>Предложений в абзаце (от - до)</label>
  <div class="input-group mb-2">
    <input name="sent_min" class="form-control">
    <input name="sent_max" class="form-control">
  </div>
  <label>Абзацев (от - до)</label>
  <div class="input-group mb-2">
    <input name="para_min" class="form-control">
    <input name="para_max" class="form-control">
  </div>
  <div class="form-check mb-2">
    <input class="form-check-input" type="checkbox" name="as_html" id="as_html">
    <label class="form-check-label" for="as_html">Формировать HTML</label>
  </div>
  <label>Размер HTML (КБ, от - до)</label>
  <div class="input-group mb-2">
    <input name="html_min_kb" class="form-control">
    <input name="html_max_kb" class="form-control">
  </div>
  <label>Дополнительный текст для HTML</label>
  <textarea name="html_extra" class="form-control"></textarea>
</div>
<div id="multi_fields" style="display:none;">
  <label>Выражение</label>
  <textarea name="expression" class="form-control"></textarea>
  <label>Кодирование</label>
  <select name="encoding" class="form-select">
    <option value="none">Без кодирования</option>
    <option value="base64">Base64</option>
    <option value="quoted-printable">QUOTED-PRINTABLE</option>
  </select>
</div>
 <div class="mb-3">
 <label>Частота обновления (N)</label><input name="frequency" class="form-control" value="1">
</div>
 <button class="btn btn-primary">Сохранить</button>
 <button type="button" class="btn btn-secondary" id="test_btn">ТЕСТ</button>
 <div id="test_result" class="mt-2"></div>
</form>
<script>
const typeSelect = document.getElementById('macro_type');
function updateFields() {
  const t = typeSelect.value;
  document.getElementById('counter_fields').style.display = t==='counter' ? '' : 'none';
  document.getElementById('random_fields').style.display = t==='random' ? '' : 'none';
  document.getElementById('list_fields').style.display = t==='list' ? '' : 'none';
  document.getElementById('multi_fields').style.display = t==='multi' ? '' : 'none';
}
typeSelect.addEventListener('change', updateFields);
updateFields();

document.getElementById('test_btn').addEventListener('click', () => {
  const form = document.querySelector('form');
  const data = new FormData(form);
  fetch('{{ url_for('macro_test') }}', {method: 'POST', body: data})
    .then(r => r.text())
    .then(t => { document.getElementById('test_result').innerText = t; });
});
</script>
{% endblock %}
